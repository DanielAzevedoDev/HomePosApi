version: "2023.0"

services:
  home-api-build:
    type: simpleRunner
    name: Build and Publish Docker Image
    steps:
      - step:
          name: Docker Build
          type: dockerCommand
          parameters:
            commandType: build
            source: file
            contextPath: .
            dockerFile: Dockerfile
            tags: 
              - 192.168.1.136:30095/home-api:latest
      - step:
          name: Docker Push
          type: dockerCommand
          parameters:
            commandType: push
            imageNames: 
              - 192.168.1.136:30095/home-api:latest
    requirements:
      - parameter: docker.server.version
        condition: exists

  home-api-test:
    type: simpleRunner
    name: Run Application Tests
    steps:
      - step:
          name: Unit Tests
          type: gradle-runner
          parameters:
            tasks: test
            gradleParams: --info --stacktrace
    requirements:
      - parameter: gradle.version
        condition: exists

  home-api-deploy:
    type: simpleRunner
    name: Deploy Docker Container
    steps:
      - step:
          name: Run Container
          type: dockerCommand
          parameters:
            commandType: run
            imageName: 192.168.1.136:30095/home-api:latest
            containerName: home-api
            ports: 
              - "8086:8080"
    requirements:
      - parameter: docker.server.version
        condition: exists